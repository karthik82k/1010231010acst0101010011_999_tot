ALTER procedure [dbo].[usp_GetState] (
	@ID	smallint
	,@COUNTRY_ID tinyint
    )
    As
    /*Created BY - Sinish on 2017/10/30 
	0= all states else one state*/
Begin
	Select 
		 [ID]
		,[COUNTRY_ID]
		,[NAME]
		,[CODE]
		,[STATETINPREFIX]
	From [state]
	where ID=isnull(@ID,ID) and COUNTRY_ID=isnull(@COUNTRY_ID,COUNTRY_ID)
end


USE [Total]
GO
/****** Object:  StoredProcedure [dbo].[usp_GetOrders]    Script Date: 2/2/2018 10:06:11 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER procedure [dbo].[usp_GetOrders] (
	@COMPANY_ID	int = NULL
	,@FINANCIALYEAR_ID tinyint = NULL
	,@PREFIX NVARCHAR(20) = NULL
	,@VOUCHER_ID INT = NULL
	,@PURCHASE_ORDER_VOUCHER_ID INT = NULL
	,@ISSALESORDER BIT
	,@ISACTIVE BIT =NULL
    )
    As
    /*Created BY - Sinish on 2017/11/28 
	0= all states else one state*/
Begin
IF @ISSALESORDER = 0
	BEGIN
		declare @GRNNO nvarchar(25)
		select 
			TOP 1 @PURCHASE_ORDER_VOUCHER_ID=PURCHASE_ORDER_VOUCHER_ID
		FROM 
			GRN with(nolock) 
		WHERE 
			PREFIX=@PREFIX and VOUCHER_ID=@VOUCHER_ID and COMPANY_ID=@COMPANY_ID and FINANCIALYEAR_ID= @FINANCIALYEAR_ID and ISACTIVE=isnull(@isactive,ISACTIVE)
--			PREFIX=@PREFIX and VOUCHER_ID=@VOUCHER_ID and PURCHASE_ORDER_VOUCHER_ID=isnull(@PURCHASE_ORDER_VOUCHER_ID,PURCHASE_ORDER_VOUCHER_ID) and COMPANY_ID=@COMPANY_ID and FINANCIALYEAR_ID= @FINANCIALYEAR_ID and ISACTIVE=isnull(@isactive,ISACTIVE)
		IF @@ROWCOUNT>0
			BEGIN
				SELECT 
					 O.ID
					,G.[GRNNO]
					,G.[GRNDATETIME]
					,O.[DATE]
					,O.[PREFIX]
					,O.[VOUCHER_ID]
					,O.[VALIDITY]
					,O.[ISSALESORDER]
					,O.[ACCOUNT_ID]
					,A.ACCOUNTDESC AS ACCOUNT
					,O.[LEDGER_ID]
					,L.ACCOUNTDESC AS LEDGER
					,G.[ITEM_ID]
					,I.NAME AS ITEM_NAME
					,G.[UNIT_ID]
					,U.NAME AS UNIT
					,G.[RATE]
					,G.[QTY]
					,G.[QTY]-G.[VOUCHERQTY] as BALANCEQTY
					,G.[VOUCHERQTY]
					,G.[AMOUNT]
					,O.[ISACTIVE]
					,I.[STOCK]
					,ORR.[PURCHASE_ORDER_NO]
					,ORR.[QUOTATION_REFERENCE]
					,ORR.[QUOTATION_REFERENCE_DATE]
					,ORR.[PROJECT_REFERNCE]
					,ORR.[VENDOR_CODE]
					,ORR.[CREDIT_PERIOD]
					,ORR.[DELIVERY_FROM]
					,ORR.[DELIVERY_TO]
					,ORR.[TEST_CERTIFICATE]
					,ORR.[PARTYADDRESS_ID]
					,ORR.[TRANSPORTATION]
					,ORR.[ORDER_JURISDICTION]
					,ORR.[TermsandConditions]
				 FROM ORDERS O with (nolock) 
						JOIN Account A  with (nolock) ON O.ACCOUNT_ID=A.ID
						JOIN ACCOUNT L  with (nolock) ON O.LEDGER_ID=L.ID
						JOIN Item I  with (nolock) ON O.ITEM_ID=I.ID
						JOIN Unit U  with (nolock) ON O.UNIT_ID=U.ID
						JOIN GRN G WITH (NOLOCK) ON O.VOUCHER_ID = G.PURCHASE_ORDER_VOUCHER_ID  and o.PREFIX=g.purchase_order_prefix and O.ITEM_ID = G.ITEM_ID and G.FINANCIALYEAR_ID=@FINANCIALYEAR_ID AND G.company_id=@COMPANY_ID
						Join ORDERREFERENCE ORR with (nolock) on o.PREFIX=orr.PREFIX and o.VOUCHER_ID=orr.VOUCHER_ID and ORR.FINANCIALYEAR_ID=@FINANCIALYEAR_ID AND ORR.company_id=@COMPANY_ID
				  WHERE G.COMPANY_ID=ISNULL(@COMPANY_ID,G.COMPANY_ID) 
					 AND G.[FINANCIALYEAR_ID]=ISNULL(@FINANCIALYEAR_ID,G.FINANCIALYEAR_ID)
					 AND G.[PREFIX] = ISNULL(@PREFIX,G.PREFIX)
					 AND G.[VOUCHER_ID]=ISNULL(@VOUCHER_ID,G.VOUCHER_ID)
					 AND G.[ISACTIVE]=ISNULL(@ISACTIVE,G.ISACTIVE)
			END
		ELSE
			BEGIN
				SELECT 
					 O.ID
					,NULL AS GRNNO
					,NULL AS GRNDATETIME
					,O.[DATE]
					,O.[PREFIX]
					,O.[VOUCHER_ID]
					,O.[VALIDITY]
					,O.[ISSALESORDER]
					,O.[ACCOUNT_ID]
					,A.ACCOUNTDESC AS ACCOUNT
					,O.[LEDGER_ID]
					,L.ACCOUNTDESC AS LEDGER
					,O.[ITEM_ID]
					,I.NAME AS ITEM_NAME
					,O.[UNIT_ID]
					,U.NAME AS UNIT
					,O.[RATE]
					,O.[QTY]
					,O.[QTY]-O.VOUCHERQTY AS BALANCEQTY
					,o.[VOUCHERQTY]
					,O.[AMOUNT]
					,O.[ISACTIVE]
					,I.[STOCK]
					,ORR.[PURCHASE_ORDER_NO]
					,ORR.[QUOTATION_REFERENCE]
					,ORR.[QUOTATION_REFERENCE_DATE]
					,ORR.[PROJECT_REFERNCE]
					,ORR.[VENDOR_CODE]
					,ORR.[CREDIT_PERIOD]
					,ORR.[DELIVERY_FROM]
					,ORR.[DELIVERY_TO]
					,ORR.[TEST_CERTIFICATE]
					,ORR.[PARTYADDRESS_ID]
					,ORR.[TRANSPORTATION]
					,ORR.[ORDER_JURISDICTION]
					,ORR.[TermsandConditions]
				 FROM ORDERS O with (nolock) 
						JOIN Account A  with (nolock) ON O.ACCOUNT_ID=A.ID
						JOIN ACCOUNT L  with (nolock) ON O.LEDGER_ID=L.ID
						JOIN Item I  with (nolock) ON O.ITEM_ID=I.ID
						JOIN Unit U  with (nolock) ON O.UNIT_ID=U.ID
						Left Outer Join ORDERREFERENCE ORR with (nolock) on o.PREFIX=orr.PREFIX and o.VOUCHER_ID=orr.VOUCHER_ID and ORR.FINANCIALYEAR_ID=@FINANCIALYEAR_ID
				  WHERE O.COMPANY_ID=ISNULL(@COMPANY_ID,O.COMPANY_ID) 
					 AND O.[FINANCIALYEAR_ID]=ISNULL(@FINANCIALYEAR_ID,O.FINANCIALYEAR_ID)
					 AND O.[PREFIX] = ISNULL(@PREFIX,O.PREFIX)
					 AND O.[VOUCHER_ID]=ISNULL(@VOUCHER_ID,O.VOUCHER_ID)
					 AND O.[ISACTIVE]=ISNULL(@ISACTIVE,O.ISACTIVE)
			END
	end
ELSE
	BEGIN
		SELECT 
			 O.ID
			,NULL AS GRNNO
			,NULL AS GRNDATETIME
			,O.[DATE]
			,O.[PREFIX]
			,O.[VOUCHER_ID]
			,O.[VALIDITY]
			,O.[ISSALESORDER]
			,O.[ACCOUNT_ID]
			,A.ACCOUNTDESC AS ACCOUNT
			,O.[LEDGER_ID]
			,L.ACCOUNTDESC AS LEDGER
			,O.[ITEM_ID]
			,I.NAME AS ITEM_NAME
			,O.[UNIT_ID]
			,U.NAME AS UNIT
			,O.[RATE]
			,O.[QTY]
			,O.[QTY]-O.VOUCHERQTY AS BALANCEQTY
			,o.[VOUCHERQTY]
			,O.[AMOUNT]
			,O.[ISACTIVE]
			,I.[STOCK]
			,ORR.[PURCHASE_ORDER_NO]
			,ORR.[QUOTATION_REFERENCE]
			,ORR.[QUOTATION_REFERENCE_DATE]
			,ORR.[PROJECT_REFERNCE]
			,ORR.[VENDOR_CODE]
			,ORR.[CREDIT_PERIOD]
			,ORR.[DELIVERY_FROM]
			,ORR.[DELIVERY_TO]
			,ORR.[TEST_CERTIFICATE]
			,ORR.[PARTYADDRESS_ID]
			,ORR.[TRANSPORTATION]
			,ORR.[ORDER_JURISDICTION]
			,ORR.[TermsandConditions]
		 FROM ORDERS O with (nolock) 
				JOIN Account A  with (nolock) ON O.ACCOUNT_ID=A.ID
				JOIN ACCOUNT L  with (nolock) ON O.LEDGER_ID=L.ID
				JOIN Item I  with (nolock) ON O.ITEM_ID=I.ID
				JOIN Unit U  with (nolock) ON O.UNIT_ID=U.ID
				Left Outer Join ORDERREFERENCE ORR with (nolock) on o.PREFIX=orr.PREFIX and o.VOUCHER_ID=orr.VOUCHER_ID and ORR.FINANCIALYEAR_ID=@FINANCIALYEAR_ID
		  WHERE O.COMPANY_ID=ISNULL(@COMPANY_ID,O.COMPANY_ID) 
			 AND O.[FINANCIALYEAR_ID]=ISNULL(@FINANCIALYEAR_ID,O.FINANCIALYEAR_ID)
			 AND O.[PREFIX] = ISNULL(@PREFIX,O.PREFIX)
			 AND O.[VOUCHER_ID]=ISNULL(@VOUCHER_ID,O.VOUCHER_ID)
			 AND O.[ISACTIVE]=ISNULL(@ISACTIVE,O.ISACTIVE)
	END
END

USE [Total]
GO
/****** Object:  StoredProcedure [dbo].[usp_GetGRNOrders]    Script Date: 02/02/2018 22:15:57 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
  
ALTER procedure [dbo].[usp_GetGRNOrders] (  
 @COMPANY_ID int   
 ,@FINANCIALYEAR_ID tinyint  
 ,@ISSALESORDER BIT  
 ,@ACCOUNTID INT  
    )  
    As  
    /*Created BY - Sinish on 2017/11/28   
 0= all states else one state*/  
 
BEGIN  
 SELECT   
  DISTINCT O.PREFIX, O.VOUCHER_ID, O.[DATE],REPLICATE('0',6-LEN(RTRIM(O.VOUCHER_ID))) + RTRIM(O.VOUCHER_ID) as id  
 FROM   
  ORDERS  O with (nolock)   
  WHERE O.COMPANY_ID=@COMPANY_ID   
   AND O.[FINANCIALYEAR_ID]=@FINANCIALYEAR_ID  
   AND O.[ISSALESORDER]=@ISSALESORDER  
   AND O.ACCOUNT_ID=@ACCOUNTID  
   AND O.[ISACTIVE]=1  
   AND O.[QTY]-isnull(O.[VOUCHERQTY],0)>0  
END  
 

