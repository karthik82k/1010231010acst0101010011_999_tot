USE [Total]
GO
/****** Object:  StoredProcedure [dbo].[usp_GetDebitnote]    Script Date: 02/20/2018 19:36:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[usp_GetDebitnote] (
	@COMPANY_ID	int = NULL
	,@FINANCIALYEAR_ID tinyint = NULL
	,@PREFIX NVARCHAR(20) = NULL
	,@VOUCHER_ID INT = NULL
	,@ISACTIVE BIT =NULL
    )
    As
    /*Created BY - Sinish on 2017/11/28 
	0= all states else one state*/
Begin
	SELECT 
		AA.ID,
		AA.COMPANY_ID,
		AA.DATE,
		AA.MONTH,
		AA.YEAR,
		AA.FINANCIALYEAR_ID,
		AA.PREFIX,
		AA.VOUCHER_ID,
		AA.REFNUM,
		AA.DR_ACCOUNT_ID,
		DR.ACCOUNTDESC AS [ACCOUNT],
		AA.CR_ACCOUNT_ID,
		CR.ACCOUNTDESC AS [LEDGER],
		AA.AMOUNT,
		AA.ITEM_ID,
		AA.QUANTITY,
		AA.UNIT_ID,
		IT.[NAME] AS [ITEM],
		U.[NAME] AS [UNIT],
		AA.RATE,
		AA.DISCOUNT,
		AA.CGSTPERCENT,
		AA.SGSTPERCENT,
		AA.IGSTPERCENT,
		AA.VATPERCENT,
		AA.CGSTAMOUNT,
		AA.SGSTAMOUNT,
		AA.IGSTAMOUNT,
		AA.VATAMOUNT,
		(select top 1 NARRATION from AccountTran with(nolock) where[FINANCIALYEAR_ID]=ISNULL(@FINANCIALYEAR_ID,0) AND  [PREFIX] = ISNULL(@PREFIX,'A') AND VOUCHER_ID=ISNULL(@VOUCHER_ID,0)  ) as NARRATION,
		AA.companytax_id,
		AA.ISACTIVE,
		REPLICATE('0',6-LEN(RTRIM(AA.VOUCHER_ID))) + RTRIM(AA.VOUCHER_ID) as V_ID,
		It.HSNCODE,
		DR.TINNO,
		AA.BILLNO,
		AA.BILLDATE,
		DR.REVERSE_CHARGES_APPLICABLE
	 FROM AllAccountTran AA with (nolock) 
			--join AccountTran A with (nolock)  on AA.DR_ACCOUNT_ID=a.DR_ACCOUNT_ID and AA.VOUCHER_ID=ISNULL(@VOUCHER_ID,A.VOUCHER_ID)
			JOIN Account DR with (nolock)  ON AA.DR_ACCOUNT_ID=DR.ID
			JOIN ACCOUNT CR with (nolock)  ON AA.CR_ACCOUNT_ID=CR.ID
			JOIN Item It with (nolock)  ON AA.ITEM_ID=It.ID
			JOIN Unit U with (nolock)  ON AA.UNIT_ID=U.ID
	  WHERE AA.COMPANY_ID=ISNULL(@COMPANY_ID,AA.COMPANY_ID) 
		 AND AA.[FINANCIALYEAR_ID]=ISNULL(@FINANCIALYEAR_ID,AA.FINANCIALYEAR_ID)
		 AND AA.[PREFIX] = ISNULL(@PREFIX,AA.PREFIX)
		 AND AA.[VOUCHER_ID]=ISNULL(@VOUCHER_ID,AA.VOUCHER_ID)
		 AND AA.[ISACTIVE]=ISNULL(@ISACTIVE,AA.ISACTIVE)
	ORDER BY AA.ID
End

USE [Total]
GO
/****** Object:  StoredProcedure [dbo].[usp_GetCreditnote]    Script Date: 02/20/2018 20:22:06 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




--alter table allaccounttran add companytax_id int
--go



ALTER procedure [dbo].[usp_GetCreditnote] (
	@COMPANY_ID	int = NULL
	,@FINANCIALYEAR_ID tinyint = NULL
	,@PREFIX NVARCHAR(20) = NULL
	,@VOUCHER_ID INT = NULL
	,@ISACTIVE BIT =NULL
    )
    As
    /*Created BY - Sinish on 2017/11/28 
	0= all states else one state*/
Begin
	SELECT 
		AA.ID,
		AA.COMPANY_ID,
		AA.DATE,
		AA.MONTH,
		AA.YEAR,
		AA.FINANCIALYEAR_ID,
		AA.PREFIX,
		AA.VOUCHER_ID,
		AA.REFNUM,
		AA.DR_ACCOUNT_ID,
		DR.ACCOUNTDESC AS [LEDGER],
		AA.CR_ACCOUNT_ID,
		CR.ACCOUNTDESC AS [ACCOUNT],
		AA.AMOUNT,
		AA.ITEM_ID,
		AA.QUANTITY,
		AA.UNIT_ID,
		IT.[NAME] AS [ITEM],
		U.[NAME] AS [UNIT],
		AA.RATE,
		AA.DISCOUNT,
		AA.CGSTPERCENT,
		AA.SGSTPERCENT,
		AA.IGSTPERCENT,
		AA.VATPERCENT,
		AA.CGSTAMOUNT,
		AA.SGSTAMOUNT,
		AA.IGSTAMOUNT,
		AA.VATAMOUNT,
		(select top 1 NARRATION from AccountTran with(nolock) where[FINANCIALYEAR_ID]=ISNULL(@FINANCIALYEAR_ID,0) AND  [PREFIX] = ISNULL(@PREFIX,'A') AND VOUCHER_ID=ISNULL(@VOUCHER_ID,0)  ) as NARRATION,
		AA.companytax_id,
		AA.ISACTIVE,
		REPLICATE('0',6-LEN(RTRIM(AA.VOUCHER_ID))) + RTRIM(AA.VOUCHER_ID) as V_ID,
		It.HSNCODE,
		CR.TINNO,
		AA.BILLNO,
		AA.BILLDATE,
		DR.REVERSE_CHARGES_APPLICABLE
	 FROM AllAccountTran AA  with (nolock) 
			--Left outer join AccountTran A  with (nolock)  on AA.CR_ACCOUNT_ID=a.CR_ACCOUNT_ID and AA.VOUCHER_ID=ISNULL(@VOUCHER_ID,A.VOUCHER_ID)
			JOIN Account DR with (nolock)  ON AA.DR_ACCOUNT_ID=DR.ID
			JOIN ACCOUNT CR with (nolock)  ON AA.CR_ACCOUNT_ID=CR.ID
			JOIN Item It with (nolock)  ON AA.ITEM_ID=It.ID
			JOIN Unit U with (nolock)  ON AA.UNIT_ID=U.ID
	  WHERE AA.COMPANY_ID=ISNULL(@COMPANY_ID,AA.COMPANY_ID) 
		 AND AA.[FINANCIALYEAR_ID]=ISNULL(@FINANCIALYEAR_ID,AA.FINANCIALYEAR_ID)
		 AND AA.[PREFIX] = ISNULL(@PREFIX,AA.PREFIX)
		 AND AA.[VOUCHER_ID]=ISNULL(@VOUCHER_ID,AA.VOUCHER_ID)
		 AND AA.[ISACTIVE]=ISNULL(@ISACTIVE,AA.ISACTIVE)
	ORDER BY AA.ID
End

